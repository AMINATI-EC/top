export default {
  async fetch(request, env, ctx) {
    // CORSè¨­å®š
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      'Access-Control-Max-Age': '86400',
    };

    // OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ï¼ˆCORS ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆï¼‰
    if (request.method === 'OPTIONS') {
      return new Response(null, { 
        status: 204,
        headers: corsHeaders 
      });
    }

    const url = new URL(request.url);
    const path = url.pathname;

    try {
      // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
      if (path === '/' && request.method === 'GET') {
        // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        return new Response(JSON.stringify({ 
          status: 'ok',
          message: 'Image Upload API with Email Service is running!',
          timestamp: new Date().toISOString(),
          features: ['image-upload', 'email-notification']
        }), {
          status: 200,
          headers: {
            ...corsHeaders,
            'Content-Type': 'application/json',
          },
        });
      }

      if (path === '/health' && request.method === 'GET') {
        // åˆ¥ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        return new Response(JSON.stringify({ 
          status: 'ok',
          service: 'ec-image-uploader',
          version: '2.0.0',
          email_service: env.RESEND_API_KEY ? 'configured' : 'not_configured'
        }), {
          status: 200,
          headers: {
            ...corsHeaders,
            'Content-Type': 'application/json',
          },
        });
      }

      if (path === '/upload' && request.method === 'POST') {
        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        return await handleUpload(request, env, corsHeaders);
      }

      // æ–°æ©Ÿèƒ½ï¼šãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆ
      if (path === '/test-email' && request.method === 'GET') {
        return await sendTestEmail(env, corsHeaders);
      }

      // æ–°æ©Ÿèƒ½ï¼šæ³¨æ–‡ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡
      if (path === '/send-order-email' && request.method === 'POST') {
        return await sendOrderEmail(request, env, corsHeaders);
      }

      // 404 Not Found
      return new Response(JSON.stringify({ 
        error: 'Not Found',
        path: path,
        method: request.method,
        available_endpoints: [
          'GET /',
          'GET /health', 
          'POST /upload',
          'GET /test-email',
          'POST /send-order-email'
        ]
      }), { 
        status: 404,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json',
        }
      });

    } catch (error) {
      console.error('Worker error:', error);
      return new Response(JSON.stringify({ 
        error: 'Internal Server Error',
        message: error.message 
      }), {
        status: 500,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json',
        },
      });
    }
  },
};

// ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ï¼ˆæ—¢å­˜æ©Ÿèƒ½ï¼‰
async function handleUpload(request, env, corsHeaders) {
  try {
    // R2ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®ç¢ºèª
    if (!env.EC_IMAGES) {
      console.log('R2 binding EC_IMAGES is not configured');
      return new Response(JSON.stringify({ 
        error: 'R2 binding EC_IMAGES is not configured',
        hint: 'Please add R2 bucket binding in Worker settings'
      }), {
        status: 500,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json',
        },
      });
    }

    // FormDataã‚’è§£æ
    const formData = await request.formData();
    const file = formData.get('file');
    const path = formData.get('path');
    const sendNotification = formData.get('sendNotification'); // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!file) {
      return new Response(JSON.stringify({ 
        error: 'Missing file in request' 
      }), {
        status: 400,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json',
        },
      });
    }

    if (!path) {
      return new Response(JSON.stringify({ 
        error: 'Missing path in request' 
      }), {
        status: 400,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json',
        },
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã®ç¢ºèª
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
      return new Response(JSON.stringify({ 
        error: 'Invalid file type',
        type: file.type,
        allowed: allowedTypes
      }), {
        status: 400,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json',
        },
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèªï¼ˆ10MBåˆ¶é™ï¼‰
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
      return new Response(JSON.stringify({ 
        error: 'File too large',
        size: file.size,
        maxSize: maxSize
      }), {
        status: 400,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json',
        },
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ArrayBufferã¨ã—ã¦èª­ã¿è¾¼ã‚€
    const arrayBuffer = await file.arrayBuffer();
    
    // R2ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    await env.EC_IMAGES.put(path, arrayBuffer, {
      httpMetadata: {
        contentType: file.type,
        cacheControl: 'public, max-age=31536000', // 1å¹´é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      },
      customMetadata: {
        originalName: file.name,
        uploadedAt: new Date().toISOString(),
        size: file.size.toString(),
      }
    });

    const imageUrl = `https://pub-a2319224352d4abda31362be3c2b1c19.r2.dev/${path}`;
    
    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
    let emailResult = null;
    if (sendNotification === 'true' && env.RESEND_API_KEY) {
      try {
        emailResult = await sendImageUploadNotification(env, {
          imagePath: path,
          imageUrl: imageUrl,
          fileName: file.name,
          fileSize: file.size
        });
      } catch (emailError) {
        console.error('Email notification failed:', emailError);
        // ãƒ¡ãƒ¼ãƒ«å¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã¨ã—ã¦æ‰±ã†
      }
    }

    // æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
    return new Response(JSON.stringify({ 
      success: true,
      message: 'Image uploaded successfully',
      data: {
        path: path,
        size: file.size,
        type: file.type,
        name: file.name,
        url: imageUrl
      },
      email: emailResult
    }), {
      status: 200,
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json',
      },
    });

  } catch (error) {
    console.error('Upload error:', error);
    return new Response(JSON.stringify({ 
      error: 'Upload failed',
      message: error.message 
    }), {
      status: 500,
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json',
      },
    });
  }
}

// ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
async function sendTestEmail(env, corsHeaders) {
  if (!env.RESEND_API_KEY) {
    return new Response(JSON.stringify({
      error: 'RESEND_API_KEY is not configured',
      hint: 'Please add RESEND_API_KEY in Worker environment variables'
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }

  try {
    const emailData = {
      from: 'onboarding@resend.dev',
      to: ['archiver0922@gmail.com'],
      subject: 'ğŸ‰ ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ« - Cloudflare Worker',
      html: `
        <h2>ğŸ‰ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆæˆåŠŸï¼</h2>
        <p>Cloudflare Worker + Resend APIã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒã§ãã¦ã„ã¾ã™ã€‚</p>
        <p><strong>é€ä¿¡æ™‚åˆ»:</strong> ${new Date().toLocaleString('ja-JP')}</p>
        <hr>
        <p>ECã‚·ãƒ§ãƒƒãƒ—ã®æ³¨æ–‡ç¢ºèªãƒ¡ãƒ¼ãƒ«ã®æº–å‚™ãŒã§ãã¾ã—ãŸï¼</p>
        <p>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã¨é€£æºã—ãŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚‚å¯èƒ½ã§ã™ã€‚</p>
      `
    };

    const response = await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${env.RESEND_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(emailData),
    });

    const result = await response.json();

    if (response.ok) {
      return new Response(JSON.stringify({
        success: true,
        message: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸï¼',
        emailId: result.id
      }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    } else {
      throw new Error(result.message || 'ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—');
    }

  } catch (error) {
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }
}

// æ³¨æ–‡ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
async function sendOrderEmail(request, env, corsHeaders) {
  if (!env.RESEND_API_KEY) {
    return new Response(JSON.stringify({
      error: 'RESEND_API_KEY is not configured'
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }

  try {
    const orderData = await request.json();
    const { customerEmail, orderId, items, total } = orderData;

    if (!customerEmail || !orderId) {
      return new Response(JSON.stringify({
        error: 'Missing required fields: customerEmail, orderId'
      }), {
        status: 400,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }

    const itemsHtml = items ? items.map(item => 
      `<li>${item.name} - Â¥${item.price} Ã— ${item.quantity}</li>`
    ).join('') : '<li>å•†å“æƒ…å ±ãªã—</li>';

    const emailData = {
      from: 'onboarding@resend.dev', // æœ¬ç•ªã§ã¯ orders@yourshop.com ãªã©
      to: [customerEmail],
      subject: `ã”æ³¨æ–‡ç¢ºèª - æ³¨æ–‡ç•ªå·: ${orderId}`,
      html: `
        <h2>ğŸ›ï¸ ã”æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</h2>
        <p><strong>æ³¨æ–‡ç•ªå·:</strong> ${orderId}</p>
        <p><strong>æ³¨æ–‡æ—¥æ™‚:</strong> ${new Date().toLocaleString('ja-JP')}</p>
        
        <h3>ã”æ³¨æ–‡å†…å®¹:</h3>
        <ul>${itemsHtml}</ul>
        
        ${total ? `<p><strong>åˆè¨ˆé‡‘é¡:</strong> Â¥${total}</p>` : ''}
        
        <hr>
        <p>å•†å“ã®ç™ºé€æº–å‚™ãŒã§ãæ¬¡ç¬¬ã€æ”¹ã‚ã¦ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚</p>
        <p>ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
      `
    };

    const response = await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${env.RESEND_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(emailData),
    });

    const result = await response.json();

    if (response.ok) {
      return new Response(JSON.stringify({
        success: true,
        message: 'Order confirmation email sent successfully',
        emailId: result.id,
        orderId: orderId
      }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    } else {
      throw new Error(result.message || 'Failed to send order email');
    }

  } catch (error) {
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }
}

// ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
async function sendImageUploadNotification(env, imageInfo) {
  const emailData = {
    from: 'onboarding@resend.dev',
    to: ['archiver0922@gmail.com'], // ç®¡ç†è€…ã‚¢ãƒ‰ãƒ¬ã‚¹
    subject: 'ğŸ“· æ–°ã—ã„ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ',
    html: `
      <h2>ğŸ“· ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€šçŸ¥</h2>
      <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${imageInfo.fileName}</p>
      <p><strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆ:</strong> ${imageInfo.imagePath}</p>
      <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:</strong> ${(imageInfo.fileSize / 1024).toFixed(2)} KB</p>
      <p><strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚åˆ»:</strong> ${new Date().toLocaleString('ja-JP')}</p>
      
      <p><strong>ç”»åƒURL:</strong></p>
      <p><a href="${imageInfo.imageUrl}">${imageInfo.imageUrl}</a></p>
      
      <img src="${imageInfo.imageUrl}" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒ" style="max-width: 300px; max-height: 300px;">
    `
  };

  const response = await fetch('https://api.resend.com/emails', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${env.RESEND_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(emailData),
  });

  const result = await response.json();
  return response.ok ? result : null;
}