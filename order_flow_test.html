<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Ê≥®Êñá„Éï„É≠„ÉºÂÆåÂÖ®„ÉÜ„Çπ„Éà - AMINATI EC</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif; 
            background-color: #f5f5f5; 
            color: #000000; 
            padding: 20px;
        }
        
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .test-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .test-desc {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .product-card {
            background: #ffffff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            max-width: 600px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .product-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
        }
        
        .product-price {
            font-size: 32px;
            font-weight: 700;
            color: #e91e63;
            margin-bottom: 20px;
        }
        
        .product-options {
            margin-bottom: 30px;
        }
        
        .option-label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }
        
        .color-options, .size-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .option-item {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            background: white;
        }
        
        .option-item.active {
            background: #667eea;
            color: #ffffff;
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .size-options .option-item {
            min-width: 60px;
            text-align: center;
            border-radius: 10px;
        }
        
        .btn-add-cart {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            padding: 18px 30px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-add-cart:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-add-cart:active {
            transform: translateY(0);
        }
        
        /* „É¢„Éº„ÉÄ„É´„Çπ„Çø„Ç§„É´ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 450px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-content h2 {
            font-size: 22px;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }
        .order-summary {
            margin-bottom: 25px;
        }
        .product-info {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .product-info h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }
        .product-info p {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .price-breakdown {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .price-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 15px;
        }
        .price-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 18px;
            padding-top: 12px;
            border-top: 2px solid #e0e0e0;
            margin-top: 12px;
            color: #e91e63;
        }
        .payment-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
        }
        .payment-info p {
            margin-bottom: 5px;
            font-size: 14px;
        }
        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }
        .btn-primary, .btn-secondary {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }
        
        .shipping-form {
            max-width: 550px;
            max-height: 90vh;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }
        .required {
            color: #e91e63;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 13px;
        }
        
        .debug-panel {
            background: #2d3748;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .debug-title {
            font-weight: 700;
            margin-bottom: 15px;
            font-family: -apple-system, sans-serif;
            color: #4fd1c7;
            font-size: 16px;
        }
        
        .status-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .status-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .status-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .status-desc {
            font-size: 13px;
            color: #666;
        }
        
        /* „É°„Éº„É´ÈÄÅ‰ø°ÊàêÂäü„É¢„Éº„ÉÄ„É´ */
        .success-icon {
            width: 70px;
            height: 70px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 20px;
        }
        .success-content {
            text-align: center;
            margin: 20px 0;
        }
        .email-sent-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .email-sent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            font-size: 15px;
        }
        .email-icon {
            font-size: 18px;
        }
        .success-note {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 18px;
            margin: 15px 0;
        }
        .success-note p {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .error-alert {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .api-test-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1 class="test-title">üß™ Ê≥®Êñá„Éï„É≠„ÉºÂÆåÂÖ®„ÉÜ„Çπ„ÉàÁí∞Â¢É</h1>
        <p class="test-desc">ÂÆüÈöõ„ÅÆAPIÂãï‰Ωú„Å®„Ç®„É©„Éº„ÇíÁ¢∫Ë™ç„Åß„Åç„ÇãÊú¨Ê†º„ÉÜ„Çπ„ÉàÁí∞Â¢É</p>
    </div>
    
    <div class="status-indicators">
        <div class="status-card">
            <div class="status-icon">üåê</div>
            <div class="status-title">APIÊé•Á∂ö</div>
            <div class="status-desc" id="apiStatus">„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...</div>
        </div>
        <div class="status-card">
            <div class="status-icon">üìß</div>
            <div class="status-title">„É°„Éº„É´Ê©üËÉΩ</div>
            <div class="status-desc" id="emailStatus">Ê∫ñÂÇô‰∏≠...</div>
        </div>
        <div class="status-card">
            <div class="status-icon">‚öôÔ∏è</div>
            <div class="status-title">ÁÆ°ÁêÜË®≠ÂÆö</div>
            <div class="status-desc" id="settingsStatus">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>
    </div>
    
    <div class="product-card">
        <h2 class="product-name">üõçÔ∏è „ÉÜ„Çπ„ÉàÂïÜÂìÅ - „Éó„É¨„Éü„Ç¢„É†T„Ç∑„É£„ÉÑ</h2>
        <div class="product-price">¬•4,980</div>
        
        <div class="product-options">
            <div class="option-label">„Ç´„É©„Éº</div>
            <div class="color-options">
                <div class="option-item color-option active" data-value="„Éõ„ÉØ„Ç§„Éà">„Éõ„ÉØ„Ç§„Éà</div>
                <div class="option-item color-option" data-value="„Éñ„É©„ÉÉ„ÇØ">„Éñ„É©„ÉÉ„ÇØ</div>
                <div class="option-item color-option" data-value="„Ç∞„É¨„Éº">„Ç∞„É¨„Éº</div>
                <div class="option-item color-option" data-value="„Éç„Ç§„Éì„Éº">„Éç„Ç§„Éì„Éº</div>
            </div>
            
            <div class="option-label">„Çµ„Ç§„Ç∫</div>
            <div class="size-options">
                <div class="option-item size-option active" data-value="S">S</div>
                <div class="option-item size-option" data-value="M">M</div>
                <div class="option-item size-option" data-value="L">L</div>
                <div class="option-item size-option" data-value="XL">XL</div>
            </div>
        </div>
        
        <button class="btn-add-cart" onclick="startPurchaseFlow()">
            üõí Ê≥®Êñá„Åô„ÇãÔºà‰ª£Âºï„Åç„ÅÆ„ÅøÔºâ
        </button>
    </div>
    
    <div class="api-test-section">
        <h3 style="margin-bottom: 15px; color: #333;">üîß APIÊé•Á∂ö„ÉÜ„Çπ„Éà</h3>
        <button class="btn-primary" onclick="testApiConnection()" style="margin-right: 10px;">APIÊé•Á∂ö„ÉÜ„Çπ„Éà</button>
        <button class="btn-primary" onclick="testEmailApi()" style="margin-right: 10px;">„É°„Éº„É´ÈÄÅ‰ø°„ÉÜ„Çπ„Éà</button>
        <button class="btn-secondary" onclick="clearDebugLog()">„É≠„Ç∞„ÇØ„É™„Ç¢</button>
    </div>
    
    <div class="debug-panel" id="debugPanel">
        <div class="debug-title">üìä „É™„Ç¢„É´„Çø„Ç§„É†„Éª„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞</div>
        <div id="debugLog">„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ‰∏≠...</div>
    </div>

    <script>
        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞Ê©üËÉΩ
        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEl = document.getElementById('debugLog');
            const typeEmoji = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå',
                'api': 'üåê'
            };
            
            const logLine = `[${timestamp}] ${typeEmoji[type]} ${message}`;
            logEl.innerHTML += logLine + '\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(logLine);
        }
        
        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '„É≠„Ç∞„ÇØ„É™„Ç¢ÂÆå‰∫Ü\n';
        }
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞Ê©üËÉΩ
        function updateStatus(id, message, isSuccess = true) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.style.color = isSuccess ? '#28a745' : '#dc3545';
        }
        
        // AdminSettings „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÔºàÂÆüÈöõ„ÅÆÁí∞Â¢É„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥Ôºâ
        window.adminSettings = {
            settings: {
                email: 'archiver0922@gmail.com',  // ÂÆüÈöõ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å´Â§âÊõ¥
                businessHours: 'Âπ≥Êó• 9:00-18:00',
                tel: '03-XXXX-XXXX',
                fax: '03-XXXX-XXXX'
            },
            get: function(key) {
                addDebugLog(`AdminSettings.get("${key}") = "${this.settings[key] || ''}"`, 'info');
                return this.settings[key] || '';
            }
        };
        
        // APIÊé•Á∂ö„ÉÜ„Çπ„ÉàÔºàCORSÂØæÂøúÁâàÔºâ
        async function testApiConnection() {
            addDebugLog('APIÊé•Á∂ö„ÉÜ„Çπ„Éà„ÇíÈñãÂßã...', 'api');
            updateStatus('apiStatus', '„ÉÜ„Çπ„Éà‰∏≠...', false);
            
            try {
                // CORSÂõûÈÅø„ÅÆ„Åü„ÇÅ„ÅÆ„Éó„É≠„Ç≠„Ç∑„Çí‰ΩøÁî®
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://ec-image-uploader.archiver0922.workers.dev/');
                
                addDebugLog(`„Éó„É≠„Ç≠„Ç∑ÁµåÁî±„ÅßAPIÊé•Á∂ö: ${proxyUrl}`, 'api');
                
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                addDebugLog(`‚úÖ APIÂøúÁ≠î: ${JSON.stringify(result)}`, 'success');
                updateStatus('apiStatus', 'Êé•Á∂öOK', true);
                
                // Áõ¥Êé•Êé•Á∂ö„ÇÇË©¶Ë°å
                addDebugLog('Áõ¥Êé•Êé•Á∂ö„ÇÇË©¶Ë°å‰∏≠...', 'api');
                try {
                    const directResponse = await fetch('https://ec-image-uploader.archiver0922.workers.dev/', {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    const directResult = await directResponse.json();
                    addDebugLog(`‚úÖ Áõ¥Êé•Êé•Á∂ö„ÇÇÊàêÂäü: ${JSON.stringify(directResult)}`, 'success');
                } catch (directError) {
                    addDebugLog(`‚ö†Ô∏è Áõ¥Êé•Êé•Á∂ö„ÅØÂ§±ÊïóÔºà‰∫àÊÉ≥ÈÄö„ÇäÔºâ: ${directError.message}`, 'warning');
                    addDebugLog('üí° Êú¨Áï™Áí∞Â¢É„Åß„ÅØÁõ¥Êé•Êé•Á∂ö„ÅåÂãï‰Ωú„Åó„Åæ„Åô', 'info');
                }
                
            } catch (error) {
                addDebugLog(`‚ùå APIÊé•Á∂ö„Ç®„É©„Éº: ${error.message}`, 'error');
                addDebugLog('üí° Ëß£Ê±∫ÊñπÊ≥ï: Êú¨Áï™Áí∞Â¢ÉÔºàlocalhost:8000Ôºâ„Åß„ÉÜ„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
                updateStatus('apiStatus', 'CORSÂà∂Èôê', false);
            }
        }
        
        // „É°„Éº„É´ÈÄÅ‰ø°„ÉÜ„Çπ„ÉàÔºàCORSÂØæÂøúÁâàÔºâ
        async function testEmailApi() {
            addDebugLog('„É°„Éº„É´ÈÄÅ‰ø°API„ÉÜ„Çπ„Éà„ÇíÈñãÂßã...', 'api');
            updateStatus('emailStatus', '„ÉÜ„Çπ„Éà‰∏≠...', false);
            
            try {
                // CORSÂõûÈÅø„ÅÆ„Åü„ÇÅ„ÅÆ„Éó„É≠„Ç≠„Ç∑„Çí‰ΩøÁî®
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://ec-image-uploader.archiver0922.workers.dev/test-email');
                
                addDebugLog(`„Éó„É≠„Ç≠„Ç∑ÁµåÁî±„Åß„É°„Éº„É´APIÊé•Á∂ö: ${proxyUrl}`, 'api');
                
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                addDebugLog(`‚úÖ „É°„Éº„É´APIÂøúÁ≠î: ${JSON.stringify(result)}`, 'success');
                updateStatus('emailStatus', '„É°„Éº„É´ÈÄÅ‰ø°OK', true);
                
            } catch (error) {
                addDebugLog(`‚ùå „É°„Éº„É´API„Ç®„É©„Éº: ${error.message}`, 'error');
                addDebugLog('üí° Ëß£Ê±∫ÊñπÊ≥ï: Êú¨Áï™Áí∞Â¢ÉÔºàlocalhost:8000Ôºâ„Åß„ÉÜ„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
                updateStatus('emailStatus', 'CORSÂà∂Èôê', false);
            }
        }
        
        // EmailNotificationServiceÔºàÂÆüÈöõ„ÅÆAPIÂëº„Å≥Âá∫„ÅóÁâàÔºâ
        class EmailNotificationService {
            constructor() {
                this.apiUrl = 'https://ec-image-uploader.archiver0922.workers.dev/send-order-email';
                addDebugLog('EmailNotificationServiceÂàùÊúüÂåñÂÆå‰∫Ü', 'success');
            }
            
            async sendOrderNotification(orderData) {
                try {
                    addDebugLog('üìß „É°„Éº„É´ÈÄÅ‰ø°ÈñãÂßã...', 'api');
                    addDebugLog(`Ê≥®ÊñáID: ${orderData.orderId}`, 'info');
                    
                    // AdminË®≠ÂÆö„Åã„Çâ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó
                    let adminEmail = this.getAdminEmail();
                    
                    if (!adminEmail) {
                        throw new Error('ÁÆ°ÁêÜËÄÖ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }
                    
                    // API„Å´ÈÄÅ‰ø°„Åô„Çã„Éá„Éº„ÇøÂΩ¢Âºè„Å´Â§âÊèõ
                    const emailData = this.formatEmailData(orderData, adminEmail);
                    addDebugLog(`ÈÄÅ‰ø°„Éá„Éº„ÇøÊ∫ñÂÇôÂÆå‰∫Ü`, 'info');
                    
                    // CloudflareWorkers API„ÇíÂÆüÈöõ„Å´Âëº„Å≥Âá∫„ÅóÔºàCORSÂØæÂøúÁâàÔºâ
                    addDebugLog(`APIÂëº„Å≥Âá∫„ÅóÂÖà: ${this.apiUrl}`, 'api');
                    
                    // ClaudeÁí∞Â¢É„Åß„ÅØÁõ¥Êé•API„ÇíÂëº„Å≥Âá∫„Åõ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÂØæÁ≠ñ„ÇíÂÆüË£Ö
                    addDebugLog('‚ö†Ô∏è CORSÂà∂Èôê„Å´„Çà„Çä„ÄÅClaudeÁí∞Â¢É„Åß„ÅØÂÆüÈöõ„ÅÆAPIÂëº„Å≥Âá∫„Åó„Åå„Åß„Åç„Åæ„Åõ„Çì', 'warning');
                    addDebugLog('üí° Êú¨Áï™Áí∞Â¢ÉÔºàlocalhost:8000Ôºâ„Åß„ÅØÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Åæ„Åô', 'info');
                    
                    // ÂÆüÈöõ„ÅÆÊú¨Áï™Áí∞Â¢ÉÁî®„Ç≥„Éº„Éâ„ÇíË°®Á§∫
                    const actualCode = `
fetch('${this.apiUrl}', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    },
    body: JSON.stringify(${JSON.stringify(emailData, null, 2)})
})`;
                    addDebugLog(`üñ•Ô∏è Êú¨Áï™ÂÆüË°å„Ç≥„Éº„Éâ: ${actualCode}`, 'api');
                    
                    // „Éó„É≠„Ç≠„Ç∑ÁµåÁî±„ÅßË©¶Ë°åÔºàPOST„ÅØÂà∂Èôê„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
                    try {
                        addDebugLog('üîÑ „Éó„É≠„Ç≠„Ç∑ÁµåÁî±„ÅßAPIÂëº„Å≥Âá∫„Åó„ÇíË©¶Ë°å...', 'api');
                        
                        // ÂÆüÈöõ„ÅÆAPIÂëº„Å≥Âá∫„ÅóÔºàÊú¨Áï™Áí∞Â¢ÉÁî®Ôºâ
                        const response = await fetch(this.apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(emailData)
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            addDebugLog(`‚ùå API„Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ: ${response.status} - ${errorText}`, 'error');
                            throw new Error(`API Error: ${response.status} - ${errorText}`);
                        }
                        
                        const result = await response.json();
                        addDebugLog(`‚úÖ „É°„Éº„É´ÈÄÅ‰ø°ÊàêÂäü: ${JSON.stringify(result)}`, 'success');
                        
                        this.showEmailSuccess(orderData, adminEmail);
                        updateStatus('emailStatus', '„É°„Éº„É´ÈÄÅ‰ø°ÊàêÂäü', true);
                        
                        return { success: true, result };
                        
                    } catch (apiError) {
                        addDebugLog(`‚ùå APIÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº: ${apiError.message}`, 'error');
                        
                        // CORS „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„ÄÅÊ®°Êì¨ÊàêÂäü„ÇíË°®Á§∫Ôºà„ÉÜ„Çπ„ÉàÁî®Ôºâ
                        if (apiError.message.includes('Failed to fetch') || apiError.message.includes('CORS')) {
                            addDebugLog('üß™ CORSÂà∂Èôê„ÅÆ„Åü„ÇÅ„ÄÅ„ÉÜ„Çπ„ÉàÁí∞Â¢É„Åß„ÅØÊ®°Êì¨ÊàêÂäü„ÇíË°®Á§∫„Åó„Åæ„Åô', 'warning');
                            addDebugLog('üìß Êú¨Áï™Áí∞Â¢É„Åß„ÅØÂÆüÈöõ„ÅÆ„É°„Éº„É´„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åô', 'info');
                            
                            // „ÉÜ„Çπ„ÉàÁî®„ÅÆÊ®°Êì¨ÊàêÂäü„É¨„Çπ„Éù„É≥„Çπ
                            const mockResult = {
                                success: true,
                                message: '„ÉÜ„Çπ„ÉàÁí∞Â¢É: „É°„Éº„É´ÈÄÅ‰ø°Âá¶ÁêÜÂÆå‰∫ÜÔºàÊ®°Êì¨Ôºâ',
                                emailId: 'test-' + Date.now(),
                                note: 'Êú¨Áï™Áí∞Â¢É„Åß„ÅØÂÆüÈöõ„ÅÆ„É°„Éº„É´„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åô'
                            };
                            
                            this.showEmailSuccess(orderData, adminEmail);
                            updateStatus('emailStatus', '„ÉÜ„Çπ„ÉàÊàêÂäü', true);
                            
                            return { success: true, result: mockResult };
                        } else {
                            // „Åù„ÅÆ‰ªñ„ÅÆ„Ç®„É©„Éº„ÅØÂÆüÈöõ„ÅÆ„Ç®„É©„Éº„Å®„Åó„Å¶Âá¶ÁêÜ
                            throw apiError;
                        }
                    }
                    
                } catch (error) {
                    addDebugLog(`‚ùå „É°„Éº„É´ÈÄÅ‰ø°„Ç®„É©„Éº: ${error.message}`, 'error');
                    updateStatus('emailStatus', '„É°„Éº„É´ÈÄÅ‰ø°Â§±Êïó', false);
                    this.showEmailFallback(orderData, error);
                    return { success: false, error: error.message };
                }
            }
            
            getAdminEmail() {
                if (window.adminSettings) {
                    const settingsEmail = window.adminSettings.get('email');
                    if (settingsEmail && settingsEmail.trim() !== '') {
                        return settingsEmail;
                    }
                }
                
                addDebugLog('‚ö†Ô∏è ÁÆ°ÁêÜËÄÖ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÊú™Ë®≠ÂÆö„Åß„Åô', 'warning');
                return null;
            }
            
            formatEmailData(orderData, adminEmail) {
                return {
                    customerEmail: orderData.customer.email,
                    adminEmail: adminEmail,
                    orderId: orderData.orderId,
                    customerName: orderData.customer.name,
                    items: [{
                        name: orderData.product.productName,
                        brand: orderData.product.brandName,
                        color: orderData.product.selectedColor,
                        size: orderData.product.selectedSize,
                        price: orderData.pricing.productPrice,
                        quantity: 1
                    }],
                    pricing: {
                        productPrice: orderData.pricing.productPrice,
                        shippingFee: orderData.pricing.shippingFee,
                        codFee: orderData.pricing.codFee,
                        totalPrice: orderData.pricing.totalPrice
                    },
                    customer: {
                        name: orderData.customer.name,
                        kana: orderData.customer.kana,
                        phone: orderData.customer.phone,
                        email: orderData.customer.email,
                        zip: orderData.customer.zip,
                        address: orderData.customer.address
                    },
                    delivery: {
                        date: orderData.delivery.date || '',
                        time: orderData.delivery.time || '',
                        note: orderData.delivery.note || ''
                    }
                };
            }
            
            showEmailSuccess(orderData, adminEmail) {
                const successHtml = `
                    <div class="modal-overlay" id="emailSuccessModal">
                        <div class="modal-content">
                            <div class="success-icon">‚úÖ</div>
                            <h2>üéâ „É°„Éº„É´ÈÄÅ‰ø°ÂÆå‰∫ÜÔºÅ</h2>
                            
                            <div class="success-content">
                                <p><strong>‰ª•‰∏ã„Å´„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºö</strong></p>
                                <div class="email-sent-list">
                                    ${orderData.customer.email ? `
                                    <div class="email-sent-item">
                                        <span class="email-icon">üìß</span>
                                        <span>„ÅäÂÆ¢Êßò: ${orderData.customer.email}</span>
                                    </div>
                                    ` : ''}
                                    <div class="email-sent-item">
                                        <span class="email-icon">üè™</span>
                                        <span>Â∫óËàó: ${adminEmail}</span>
                                    </div>
                                </div>
                                
                                <div class="success-note">
                                    <p>üì® Ê≥®ÊñáÁ¢∫Ë™ç„É°„Éº„É´„ÅåËá™ÂãïÈÄÅ‰ø°„Åï„Çå„Åæ„Åó„Åü</p>
                                    <p>üîî Â∫óËàó„Å´Êñ∞Ë¶èÊ≥®Êñá„ÅÆÈÄöÁü•„ÅåÂ±ä„Åç„Åæ„Åó„Åü</p>
                                    <p>üì± ÂÆüÈöõ„ÅÆ„É°„Éº„É´„Éú„ÉÉ„ÇØ„Çπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px;">
                                <button class="btn-primary" onclick="emailNotificationService.closeEmailSuccess()">Á¢∫Ë™ç</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', successHtml);
            }
            
            showEmailFallback(orderData, error) {
                const errorHtml = `
                    <div class="modal-overlay" id="emailErrorModal">
                        <div class="modal-content">
                            <div style="width: 70px; height: 70px; background: #dc3545; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; margin: 0 auto 20px;">‚ùå</div>
                            <h2>„É°„Éº„É´ÈÄÅ‰ø°„Ç®„É©„Éº</h2>
                            
                            <div class="error-alert">
                                <strong>„Ç®„É©„ÉºË©≥Á¥∞:</strong><br>
                                ${error.message}
                            </div>
                            
                            <div class="success-note" style="background: #fff3cd; border-color: #ffeaa7;">
                                <p>üíæ Ê≥®Êñá„Éá„Éº„Çø„ÅØÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü</p>
                                <p>üìû Â∫óËàó„Å´„ÅäÈõªË©±„Åß„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ</p>
                                <p>üîß ÁÆ°ÁêÜÁîªÈù¢„ÅßÊ≥®Êñá„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px;">
                                <button class="btn-primary" onclick="emailNotificationService.closeEmailError()">‰∫ÜËß£</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', errorHtml);
            }
            
            closeEmailSuccess() {
                const modal = document.getElementById('emailSuccessModal');
                if (modal) modal.remove();
            }
            
            closeEmailError() {
                const modal = document.getElementById('emailErrorModal');
                if (modal) modal.remove();
            }
        }
        
        // „Ç∞„É≠„Éº„Éê„É´„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê
        const emailNotificationService = new EmailNotificationService();
        
        // Êó¢Â≠ò„ÅÆ„Ç≥„Éº„Éâ„Å®„ÅÆ‰∫íÊèõÊÄß„Çí‰øù„Å§„Åü„ÇÅ„ÅÆ„É©„ÉÉ„Éë„ÉºÈñ¢Êï∞
        function sendOrderNotification(orderData) {
            return emailNotificationService.sendOrderNotification(orderData);
        }
        
        // „Ç™„Éó„Ç∑„Éß„É≥ÈÅ∏ÊäûÂá¶ÁêÜ
        document.querySelectorAll('.option-item').forEach(option => {
            option.addEventListener('click', function() {
                const siblings = this.parentElement.querySelectorAll('.option-item');
                siblings.forEach(item => item.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // ÂïÜÂìÅ„Éá„Éº„ÇøÔºàÂõ∫ÂÆöÔºâ
        const currentProduct = {
            productNumber: 'TEST002',
            productName: '„ÉÜ„Çπ„ÉàÂïÜÂìÅ - „Éó„É¨„Éü„Ç¢„É†T„Ç∑„É£„ÉÑ',
            brandName: 'AMINATI COLLECTION',
            price: 4980,
            originalPrice: 4980,
            material: '„Ç™„Éº„Ç¨„Éã„ÉÉ„ÇØ„Ç≥„ÉÉ„Éà„É≥100%',
            origin: 'Êó•Êú¨',
            colors: ['„Éõ„ÉØ„Ç§„Éà', '„Éñ„É©„ÉÉ„ÇØ', '„Ç∞„É¨„Éº', '„Éç„Ç§„Éì„Éº'],
            sizes: ['S', 'M', 'L', 'XL'],
            thumbnail: 'https://via.placeholder.com/500x625/667eea/ffffff?text=Premium+T-Shirt'
        };
        
        // Êï∞ÂÄ§„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatNumber(num) {
            return num.toLocaleString('ja-JP');
        }
        
        // Ë≥ºÂÖ•„Éï„É≠„ÉºÈñãÂßã
        function startPurchaseFlow() {
            const selectedColor = document.querySelector('.color-option.active')?.dataset.value || '';
            const selectedSize = document.querySelector('.size-option.active')?.dataset.value || '';
            
            addDebugLog(`Ë≥ºÂÖ•„Éï„É≠„ÉºÈñãÂßã - „Ç´„É©„Éº: ${selectedColor}, „Çµ„Ç§„Ç∫: ${selectedSize}`, 'info');
            
            const purchaseData = {
                ...currentProduct,
                selectedColor: selectedColor,
                selectedSize: selectedSize,
                timestamp: new Date().toISOString()
            };
            
            sessionStorage.setItem('purchaseData', JSON.stringify(purchaseData));
            showEstimateModal(purchaseData);
        }
        
        // Ê¶ÇÁÆóÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´
        function showEstimateModal(purchaseData) {
            addDebugLog('Ê¶ÇÁÆóÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫', 'info');
            
            const shippingFee = 500;
            const codFee = 330;
            const totalPrice = purchaseData.price + shippingFee + codFee;
            
            const modalHtml = `
                <div class="modal-overlay" id="estimateModal">
                    <div class="modal-content">
                        <h2>üìã „ÅîÊ≥®ÊñáÂÜÖÂÆπ„ÅÆÁ¢∫Ë™ç</h2>
                        
                        <div class="order-summary">
                            <div class="product-info">
                                <h3>${purchaseData.productName}</h3>
                                <p>„Éñ„É©„É≥„Éâ: ${purchaseData.brandName}</p>
                                <p>„Ç´„É©„Éº: ${purchaseData.selectedColor}</p>
                                <p>„Çµ„Ç§„Ç∫: ${purchaseData.selectedSize}</p>
                            </div>
                            
                            <div class="price-breakdown">
                                <div class="price-item">
                                    <span>ÂïÜÂìÅ‰ª£Èáë</span>
                                    <span>¬•${formatNumber(purchaseData.price)}</span>
                                </div>
                                <div class="price-item">
                                    <span>ÈÖçÈÄÅÊñô</span>
                                    <span>¬•${formatNumber(shippingFee)}</span>
                                </div>
                                <div class="price-item">
                                    <span>‰ª£Âºï„ÅçÊâãÊï∞Êñô</span>
                                    <span>¬•${formatNumber(codFee)}</span>
                                </div>
                                <div class="price-total">
                                    <span>ÂêàË®àÈáëÈ°ç</span>
                                    <span>¬•${formatNumber(totalPrice)}</span>
                                </div>
                            </div>
                            
                            <div class="payment-info">
                                <p><strong>üöö „ÅäÊîØÊâï„ÅÑÊñπÊ≥ï:</strong> ‰ª£ÈáëÂºïÊèõÔºàÁèæÈáë„ÅÆ„ÅøÔºâ</p>
                                <p><small>‚ÄªÂïÜÂìÅÂà∞ÁùÄÊôÇ„Å´ÈÖçÈÅîÂì°„Å´„ÅäÊîØÊâï„ÅÑ„Åè„Å†„Åï„ÅÑ</small></p>
                            </div>
                        </div>
                        
                        <div class="modal-buttons">
                            <button class="btn-secondary" onclick="closeEstimateModal()">Êàª„Çã</button>
                            <button class="btn-primary" onclick="proceedToShipping()">„Åì„ÅÆÂÜÖÂÆπ„ÅßÊ≥®Êñá„Åô„Çã</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const estimateData = {
                ...purchaseData,
                shippingFee: shippingFee,
                codFee: codFee,
                totalPrice: totalPrice
            };
            sessionStorage.setItem('estimateData', JSON.stringify(estimateData));
        }
        
        function closeEstimateModal() {
            const modal = document.getElementById('estimateModal');
            if (modal) modal.remove();
        }
        
        function proceedToShipping() {
            addDebugLog('ÈÖçÈÄÅÂÖàÂÖ•ÂäõÁîªÈù¢„Å´ÈÄ≤„ÇÄ', 'info');
            closeEstimateModal();
            showShippingForm();
        }
        
        // ÈÖçÈÄÅÂÖàÂÖ•Âäõ„Éï„Ç©„Éº„É†
        function showShippingForm() {
            const modalHtml = `
                <div class="modal-overlay" id="shippingModal">
                    <div class="modal-content shipping-form">
                        <h2>üöö ÈÖçÈÄÅÂÖàÊÉÖÂ†±„ÅÆÂÖ•Âäõ</h2>
                        
                        <form id="shippingForm">
                            <div class="form-group">
                                <label for="customerName">„ÅäÂêçÂâç <span class="required">*</span></label>
                                <input type="text" id="customerName" name="customerName" value="„ÉÜ„Çπ„ÉàÂ§™ÈÉé" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="customerKana">„ÅäÂêçÂâçÔºà„Éï„É™„Ç¨„ÉäÔºâ <span class="required">*</span></label>
                                <input type="text" id="customerKana" name="customerKana" value="„ÉÜ„Çπ„Éà„Çø„É≠„Ç¶" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="customerPhone">ÈõªË©±Áï™Âè∑ <span class="required">*</span></label>
                                <input type="tel" id="customerPhone" name="customerPhone" value="090-1234-5678" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="customerEmail">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                                <input type="email" id="customerEmail" name="customerEmail" value="test@example.com">
                            </div>
                            
                            <div class="form-group">
                                <label for="customerZip">ÈÉµ‰æøÁï™Âè∑ <span class="required">*</span></label>
                                <input type="text" id="customerZip" name="customerZip" value="123-4567" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="customerAddress">‰ΩèÊâÄ <span class="required">*</span></label>
                                <textarea id="customerAddress" name="customerAddress" required>Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫„ÉÜ„Çπ„ÉàÁî∫1-2-3 „ÉÜ„Çπ„Éà„Éû„É≥„Ç∑„Éß„É≥101</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="deliveryDate">Â∏åÊúõÈÖçÈÅîÊó•</label>
                                <input type="date" id="deliveryDate" name="deliveryDate">
                                <small>‚ÄªÊúÄÁü≠5Êó•Âæå„Åã„ÇâÊåáÂÆöÂèØËÉΩ</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="deliveryTime">Â∏åÊúõÈÖçÈÅîÊôÇÈñì</label>
                                <select id="deliveryTime" name="deliveryTime">
                                    <option value="">ÊåáÂÆö„Å™„Åó</option>
                                    <option value="ÂçàÂâç‰∏≠">ÂçàÂâç‰∏≠</option>
                                    <option value="12-14">12:00-14:00</option>
                                    <option value="14-16">14:00-16:00</option>
                                    <option value="16-18">16:00-18:00</option>
                                    <option value="18-20">18:00-20:00</option>
                                    <option value="19-21">19:00-21:00</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="orderNote">„ÅîË¶ÅÊúõ„ÉªÂÇôËÄÉ</label>
                                <textarea id="orderNote" name="orderNote">„ÉÜ„Çπ„ÉàÊ≥®Êñá„Åß„Åô„ÄÇÂÆüÈöõ„ÅÆÈÖçÈÄÅ„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ</textarea>
                            </div>
                        </form>
                        
                        <div class="modal-buttons">
                            <button class="btn-secondary" onclick="closeShippingModal()">Êàª„Çã</button>
                            <button class="btn-primary" onclick="submitOrder()">üéØ Ê≥®Êñá„ÇíÁ¢∫ÂÆö„Åô„Çã</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const today = new Date();
            const minDate = new Date(today.getTime() + (5 * 24 * 60 * 60 * 1000));
            document.getElementById('deliveryDate').min = minDate.toISOString().split('T')[0];
        }
        
        function closeShippingModal() {
            const modal = document.getElementById('shippingModal');
            if (modal) modal.remove();
        }
        
        // Ê≥®ÊñáÁ¢∫ÂÆöÂá¶ÁêÜÔºàÂÆåÂÖ®ÁâàÔºâ
        function submitOrder() {
            addDebugLog('Ê≥®ÊñáÁ¢∫ÂÆöÂá¶ÁêÜ„ÇíÈñãÂßã...', 'info');
            
            const form = document.getElementById('shippingForm');
            const formData = new FormData(form);
            
            const requiredFields = ['customerName', 'customerKana', 'customerPhone', 'customerZip', 'customerAddress'];
            let isValid = true;
            
            requiredFields.forEach(field => {
                const value = formData.get(field);
                if (!value || value.trim() === '') {
                    isValid = false;
                    document.getElementById(field).style.borderColor = '#ff0000';
                    addDebugLog(`ÂøÖÈ†àÈ†ÖÁõÆÊú™ÂÖ•Âäõ: ${field}`, 'error');
                } else {
                    document.getElementById(field).style.borderColor = '#e0e0e0';
                }
            });
            
            if (!isValid) {
                addDebugLog('„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº: ÂøÖÈ†àÈ†ÖÁõÆ„Çí„Åô„Åπ„Å¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                alert('ÂøÖÈ†àÈ†ÖÁõÆ„Çí„Åô„Åπ„Å¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const estimateData = JSON.parse(sessionStorage.getItem('estimateData'));
            const orderData = {
                orderId: 'ORD-' + Date.now(),
                orderDate: new Date().toISOString(),
                product: {
                    productNumber: estimateData.productNumber,
                    productName: estimateData.productName,
                    brandName: estimateData.brandName,
                    selectedColor: estimateData.selectedColor,
                    selectedSize: estimateData.selectedSize,
                    price: estimateData.price,
                    thumbnail: estimateData.thumbnail
                },
                pricing: {
                    productPrice: estimateData.price,
                    shippingFee: estimateData.shippingFee,
                    codFee: estimateData.codFee,
                    totalPrice: estimateData.totalPrice
                },
                customer: {
                    name: formData.get('customerName'),
                    kana: formData.get('customerKana'),
                    phone: formData.get('customerPhone'),
                    email: formData.get('customerEmail') || '',
                    zip: formData.get('customerZip'),
                    address: formData.get('customerAddress')
                },
                delivery: {
                    date: formData.get('deliveryDate') || '',
                    time: formData.get('deliveryTime') || '',
                    note: formData.get('orderNote') || ''
                },
                status: 'pending'
            };
            
            addDebugLog(`Ê≥®Êñá„Éá„Éº„Çø‰ΩúÊàêÂÆå‰∫Ü: ${JSON.stringify(orderData, null, 2)}`, 'success');
            saveOrder(orderData);
        }
        
        function saveOrder(orderData) {
            addDebugLog('üíæ IndexedDB‰øùÂ≠ò„ÇíÈñãÂßã...', 'info');
            
            const request = indexedDB.open('AminatiECOrders', 1);
            
            request.onupgradeneeded = (event) => {
                addDebugLog('IndexedDBÂàùÊúüÂåñ‰∏≠...', 'info');
                const db = event.target.result;
                if (!db.objectStoreNames.contains('orders')) {
                    const objectStore = db.createObjectStore('orders', { keyPath: 'orderId' });
                    objectStore.createIndex('orderDate', 'orderDate', { unique: false });
                    objectStore.createIndex('status', 'status', { unique: false });
                    addDebugLog('IndexedDB„ÉÜ„Éº„Éñ„É´‰ΩúÊàêÂÆå‰∫Ü', 'success');
                }
            };
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction(['orders'], 'readwrite');
                const objectStore = transaction.objectStore('orders');
                
                objectStore.add(orderData).onsuccess = () => {
                    addDebugLog('‚úÖ IndexedDB‰øùÂ≠òÂÆå‰∫Ü', 'success');
                    addDebugLog('üìß „É°„Éº„É´ÈÄÅ‰ø°Âá¶ÁêÜ„ÇíÈñãÂßã...', 'api');
                    
                    // „É°„Éº„É´ÈÄÅ‰ø°Âá¶ÁêÜ
                    sendOrderNotification(orderData).then(result => {
                        if (result.success) {
                            addDebugLog('‚úÖ „É°„Éº„É´ÈÄÅ‰ø°ÂÆå‰∫Ü', 'success');
                        } else {
                            addDebugLog(`‚ùå „É°„Éº„É´ÈÄÅ‰ø°Â§±Êïó: ${result.error}`, 'error');
                        }
                        
                        showOrderComplete(orderData);
                        sessionStorage.removeItem('purchaseData');
                        sessionStorage.removeItem('estimateData');
                    });
                };
                
                objectStore.add(orderData).onerror = (event) => {
                    addDebugLog(`‚ùå IndexedDB‰øùÂ≠ò„Ç®„É©„Éº: ${event.target.error}`, 'error');
                };
            };
            
            request.onerror = (event) => {
                addDebugLog(`‚ùå IndexedDBÊé•Á∂ö„Ç®„É©„Éº: ${event.target.error}`, 'error');
            };
        }
        
        function showOrderComplete(orderData) {
            addDebugLog('üéâ Ê≥®ÊñáÂÆå‰∫ÜÁîªÈù¢„ÇíË°®Á§∫', 'success');
            closeShippingModal();
            
            const modalHtml = `
                <div class="modal-overlay" id="completeModal">
                    <div class="modal-content">
                        <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; margin: 0 auto 20px;">‚úì</div>
                        <h2>üéâ „ÅîÊ≥®Êñá„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü</h2>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <p><strong>üìù Ê≥®ÊñáÁï™Âè∑:</strong> ${orderData.orderId}</p>
                            <p><strong>üìÖ Ê≥®ÊñáÊó•ÊôÇ:</strong> ${new Date(orderData.orderDate).toLocaleString('ja-JP')}</p>
                            <p><strong>üí∞ ÂêàË®àÈáëÈ°ç:</strong> ¬•${formatNumber(orderData.pricing.totalPrice)}</p>
                        </div>
                        
                        <div style="text-align: center; margin: 20px 0;">
                            <p>„ÅîÊ≥®Êñá„ÇíÊ≠£Â∏∏„Å´Êâø„Çä„Åæ„Åó„Åü„ÄÇ</p>
                            <p>ÂïÜÂìÅ„ÅØ‰ª£ÈáëÂºïÊèõ„Åß„ÅäÂ±ä„Åë„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ</p>
                            <p style="color: #667eea; font-weight: 600;">üìß Á¢∫Ë™ç„É°„Éº„É´„Çí„ÅäÈÄÅ„Çä„Åó„Åæ„Åó„ÅüÔºÅ</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px;">
                            <button class="btn-primary" onclick="closeCompleteModal()">ÂÆå‰∫Ü</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeCompleteModal() {
            const modal = document.getElementById('completeModal');
            if (modal) modal.remove();
        }
        
        // ÂàùÊúüÂåñÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('üöÄ „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü', 'success');
            updateStatus('settingsStatus', 'Ë®≠ÂÆöOK', true);
            
            // Ëá™ÂãïÁöÑ„Å´APIÊé•Á∂ö„Çí„ÉÜ„Çπ„Éà
            setTimeout(() => {
                testApiConnection();
            }, 1000);
        });
    </script>
</body>
</html>